<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-touch-fullscreen" content="yes" />
<meta name="format-detection" content="telephone=no"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="format-detection" content="telephone=no" />
<meta name="msapplication-tap-highlight" content="no" />
<meta name="viewport" content="initial-scale=1,maximum-scale=1,minimum-scale=1" />
<title>更改密码</title>
<link rel="stylesheet" type="text/css" href="../../css/base.css">
<link rel="stylesheet" type="text/css" href="../../css/nctouch_member.css">
    <link rel="stylesheet" type="text/css" href="../../js/layui-v2.5.4/layui/css/layui.css">
    <script type="text/javascript" src="../../js/layer_mobile/layer.js"></script>
</head>
<body>
<header id="header">
	<div class="header-wrap">
		<div class="header-l">
			<a href="member_account.html">
				<i class="back"></i>
			</a>
		</div>
		<div class="header-title">
			<h1>更改支付密码</h1>
		</div>
	</div>
</header>
<div class="nctouch-main-layout">
<div class="register-mobile-tip"> 支付密码由 6-20个大小写英文字母、符号或数字组成</div>
  <div class="nctouch-inp-con">
    <form action="" method ="">
    <ul class="form-box">
	<li class="form-item">
        <h4>原密码</h4>
        <div class="input-box">
          <input type="password" id="passwordold" name="passwordold" maxlength="20" size="10" class="inp" autocomplete="off" placeholder="输入原支付密码" oninput="writeClear($(this));"/>
        </div>
      </li>
      <li class="form-item">
        <h4>设置密码</h4>
        <div class="input-box">
          <input type="password" id="password" name="password" maxlength="20" size="10" class="inp" autocomplete="off" placeholder="输入支付密码" oninput="writeClear($(this));"/>
        </div>
      </li>
      <li class="form-item">
        <h4>密码确认</h4>
        <div class="input-box">
          <input type="password" id="password1" name="password" class="inp" maxlength="20" placeholder="再次输入支付密码" oninput="writeClear($(this));" onfocus="writeClear($(this));" />
          </div>
      </li>
        <li class="form-item">
            <h4>验证码</h4>
            <div class="input-box">
                <input type="text" id="code" name="code" class="inp" maxlength="20" placeholder="再次输入验证码" oninput="writeClear($(this));" onfocus="writeClear($(this));" />
                <button style="position: absolute;right: 11%;bottom: 14%" type="button" id="get_code" class="layui-btn layui-btn-sm layui-btn-radius layui-btn-normal">发送验证码</button>
            </div>
        </li>
    </ul>
    <div class="error-tips"></div>
    <div class="form-btn"><a href="javascript:void(0);" class="btn" id="nextform">提交</a></div>
    </form>
  </div>
</div>
<footer id="footer" class="bottom"></footer>
<script> var navigate_id ="5";</script> 
<script type="text/javascript" src="../../js/config.js"></script> 
<script type="text/javascript" src="../../js/zepto.min.js"></script> 
<script type="text/javascript" src="../../js/template.js"></script> 
<script type="text/javascript" src="../../js/common.js"></script> 
<script type="text/javascript" src="../../js/simple-plugin.js"></script> 

<script type="text/javascript" src="../../js/tmpl/footer.js"></script>
<script type="text/javascript">
$(function() {
    var key = getCookie('key');
    var phone = getCookie('member_mobile');
    if (!key) {
        window.location.href = WapSiteUrl+'/tmpl/member/login.html';
        return;
    }

    $.sValid.init({
        rules:{
            password: {
            	required:true,
            	minlength:6,
            	maxlength:20
            },
			passwordold: {
            	required:true,
            	minlength:6,
            	maxlength:20
            },
            password1: {
            	required:true,
            	equalTo : '#password'
            }
        },
        messages:{
        	password: {
            	required : "请填写登录密码",
            	minlength : "请正确填写登录密码",
            	maxlength : "请正确填写登录密码"
            },
			passwordold: {
            	required : "请填写登录密码",
            	minlength : "请正确填写登录密码",
            	maxlength : "请正确填写登录密码"
            },
            password1 : {
            	required:"请填写确认密码",
            	equalTo : '两次密码输入不一致'
            }
        },
        callback:function (eId,eMsg,eRules){
            if(eId.length >0){
                var errorHtml = "";
                $.map(eMsg,function (idx,item){
                    errorHtml += "<p>"+idx+"</p>";
                });
                errorTipsShow(errorHtml);
            }else{
                errorTipsHide();
            }
        }
    });

    $('#nextform').click(function(){
        if (!$(this).parent().hasClass('ok')) {
            return false;
        }
        if($.sValid()){
            var password = $.trim($("#password").val());
			var passwordold = $.trim($("#passwordold").val());
            var password1 = $.trim($("#password1").val());
            var code = $.trim($("#code").val());
            $.ajax({
                type:'post',
                url:ApiUrl+"/index.php?act=member_account&op=modify_paypassword_withold",
                data:{key:key,password:password,password1:password1, passwordold:passwordold,member_mobile:phone,code:code},
                dataType:'json',
                success:function(result){
                    if(result.code == 200){
                        $.sDialog({
                            skin:"block",
                            content:'密码修改成功',
                            okBtn:false,
                            cancelBtn:false
                        });
                    	setTimeout("location.href = WapSiteUrl+'/tmpl/member/member_account.html'",2000);
                    }else{
                        errorTipsShow('<p>' + result.datas.error + '</p>');
                    }
                }
            });
        }

    });

    var getCode = function () {
        var regex = /^((\+)?86|((\+)?86)?)0?1[3458]\d{9}$/;
        if (phone.match(regex) == null) {
            layer.open({
                content: '手机号不正确'
                , skin: 'msg'
                , time: 2 //2秒后自动关闭
            });
            return false;
        }
        sendCode(phone);  //发送验证码
    };
    $('#get_code').on('click', getCode);

    //发送验证码  "{:U('AuthGroup/addChildGroup')}"
    function sendCode(phone) {
        var sendUrl = ApiUrl + "/index.php?act=member_account&op=modify_paypassword_withold";
        var is_status = false;
        var wait = 10;
        var t_img;
        $.ajax({
            url: sendUrl,
            dataType: 'json',
            type: 'post',
            data: {phone: phone,key:key},
            cache: false,
            async: true,
            success: function (json) {
                if (json.code == 200) {  //no-click
                    layer.open({
                        content: '发送成功'
                        , skin: 'msg'
                        , time: 2
                    });
                    $('#get_code').addClass('layui-btn-disabled').removeClass('layui-btn-normal');
                    time_run()
                } else {
                    layer.open({
                        content: json.datas.error
                        , skin: 'msg'
                        , time: 2
                    });
                }
            },
            error: function () {
                layer.open({
                    content: '网络错误,请稍后再试'
                    , skin: 'msg'
                    , time: 2
                });
            }
        });

        function time_run() {
            var obj = $('#get_code');
            if (wait == 0) {
                is_status = true;
            }
            if (is_status) {
                clearTimeout(t_img); // 清除定时器
                obj.on('click', getCode);  //绑定click
                obj.addClass('layui-btn-normal').removeClass('layui-btn-disabled');
                $('#get_code').html('发送验证码');
            } else {
                is_status = false;
                obj.off('click');  //移除click
                $('#get_code').html(wait + 's后重新获取');
                wait--;
                t_img = setTimeout(function () {
                    time_run();
                }, 1000);
            }
        }
    }
});

</script>
</body>
</html>
