
<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-touch-fullscreen" content="yes" />
<meta name="format-detection" content="telephone=no"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="format-detection" content="telephone=no" />
<meta name="msapplication-tap-highlight" content="no" />
<meta name="viewport" content="initial-scale=1,maximum-scale=1,minimum-scale=1" />
<title>我的代金券</title>
<link rel="stylesheet" type="text/css" href="../../css/base.css">
<link rel="stylesheet" type="text/css" href="../../css/nctouch_member.css">
<style>
		.memberbtncenter{
			position: absolute;
			z-index: 1;
			top: 1.0rem;
			left: 6.5rem;
			width: 2rem;
			height: 1rem;
			background: #FFF;
		} 
	
		.nctouch-tickets .ticket-item .store-info dl {
			padding: 0.5rem 0 0.5rem 1rem;
	}
	 
	.nctouch-tickets .ticket-item .ticket-info {
			position: relative;
			z-index: 1;
			display: inline-block;
			vertical-align: top;
			width: 35%;
			height: 3rem;
	}
	.nctouch-tickets .ticket-item .ticket-info dt {
    font-size: 0.8rem;
    line-height: 1.2rem;
    color: #FFF;
}
	</style>
</head>
<body>
<header id="header">
  <div class="header-wrap">
    <div class="header-l"><a href="member.html"><i class="back"></i></a></div>
    <span class="header-tab"> <a href="voucher_list.html">我的增值券</a> <a  class="cur" href="voucher_pw_list.html">购买增值券</a> </span>
    <div class="header-r"> <a id="header-nav" href="javascript:void(0);"><i class="more"></i><sup></sup></a> </div>
  </div>
  <div class="nctouch-nav-layout">
    <div class="nctouch-nav-menu"> <span class="arrow"></span>
      <ul>
        <li><a href="../../index.html"><i class="home"></i>首页</a></li>
        <li><a href="../search.html"><i class="search"></i>搜索</a></li>
        <li><a href="../product_first_categroy.html"><i class="categroy"></i>分类</a></li>
        <li><a href="javascript:void(0);"><i class="message"></i>消息<sup></sup></a></li>
        <li><a href="../cart_list.html"><i class="cart"></i>购物车<sup></sup></a></li>
        <li><a href="../member/member.html"><i class="member"></i>我的商城</a></li>
      </ul>
    </div>
  </div>
</header>
<div class="nctouch-main-layout">
  <div class="nctouch-voucher-list">
    <ul class="nctouch-tickets" id="voucher-list">
    </ul>
  </div>
</div>
<div class="fix-block-r"> <a href="javascript:void(0);" class="gotop-btn gotop hide" id="goTopBtn"><i></i></a> </div>

<script type="text/html" id="voucher-list-tmpl">
<% if (voucher_list && voucher_list.length > 0) { %>
<% for (var k in voucher_list) { var v = voucher_list[k]; %>
	<li class="ticket-item normal">
		<div class="border-left"></div>
		<div class="block-center">
				<div class="ticket-info">
						<div class="bg-ico"></div>
						<% if (v.voucher_state==2) { %>
						<div class="watermark ysy"></div>
						<% } %>
						<% if (v.voucher_state==3 || v.voucher_state==4) { %>
						<div class="watermark ysx"></div>
						<% } %>
						<dl>
						<dt>￥<%= v.voucher_price %></dt>
						<dd></dd>
						</dl>
					</div>
				<div class="store-info">
					<div class="memberbtncenter btn">
							<a href="javascript:void(0);" class="cur"  data-num="<%= v.voucher_num %>" data-id="<%= v.voucher_id %>"  onclick="buyOrder(this)">购买</a>
						</div> 
					<dl>
						<dt class="store-name">编号：<%= v.voucher_title %></dt>  
						<dd>数量：<%= v.voucher_num %></dd>
					</dl>
				</div>
			
		</div>
		<div class="border-right"></div>
		</a>
	</li>
<% } %>
<li class="loading"><div class="spinner"><i></i></div>数据读取中</li>
<% } else { %>
	<div class="nctouch-norecord voucher">
		<div class="norecord-ico"><i></i></div>
		<dl>
			<dt>您还没有相关的增值券</dt>
			<dd>店铺增值券可享受商品折扣</dd>
		</dl>
	</div>
<% } %>
</script> 
<script> var navigate_id ="5";</script> 
<script type="text/javascript" src="../../js/config.js"></script> 
<script type="text/javascript" src="../../js/zepto.min.js"></script> 
<script type="text/javascript" src="../../js/template.js"></script> 
<script type="text/javascript" src="../../js/common.js"></script> 
<script type="text/javascript" src="../../js/ncscroll-load.js"></script> 
<script type="text/javascript" src="../../js/simple-plugin.js"></script>
<script>
	function showSpacing(){
		$('.spacing-div').remove();
		$('.normal').first().before('<div class="spacing-div"><span>可购买的增值券</span></div>');
	}
	function orderlist(key){
			//渲染list
			var load_class = new ncScrollLoad();
		load_class.loadInit({
			'url':ApiUrl + '/index.php?act=member_voucher&op=voucher_Canlist',
			'getparam':{'key':key,'voucher_state':1},
			'tmplid':'voucher-list-tmpl',
			'containerobj':$("#voucher-list"),
			'iIntervalId':true,
			'callback':showSpacing,
			'data':{WapSiteUrl:WapSiteUrl}
		});
	}
	//购买A金券
	function buyOrder(obj){
	var voucher_id=$(obj).attr("data-id"); 
	var voucher_num=$(obj).attr("data-num"); 
	var key = getCookie('key');
	 //申请卖出A金券
		$.ajax({
			type: 'post',
			url: ApiUrl + '/index.php?act=member_voucher&op=voucher_buyorder',
			data: {
				key:key,
				'voucher_id': voucher_id,
				'voucher_num':voucher_num 
			},
			dataType: 'json',
			async: false,
			success: function(result) {
				console.log(result)
				if (result.code == 200) {
					orderlist(key);
					$(".nctouch-inp-con").removeClass("show"); 
					$("#voucher_amount").val('');
	 				$("#voucher_price").val('');
				}else{
					$.sDialog({skin: "green", content: result.datas.error, okBtn: false, cancelBtn: false});
				    return false;
				}
			}
		});  
	}
	$(function(){
		var key = getCookie('key');
		if (!key) {
			window.location.href = WapSiteUrl+'/tmpl/member/login.html';
			return;
		}
		//渲染list
		orderlist(key);
	});
    template.helper('tsToDateString', function (t) {
        var d = new Date(parseInt(t) * 1000);
        var s = '';
        s += d.getFullYear() + '年';
        s += (d.getMonth() + 1) + '月';
        s += d.getDate() + '日';
        return s;
    });
</script>
</body>
</html>
